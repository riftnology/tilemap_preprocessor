<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select and Transform - KonvaJS Documentation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        pre code {
            background: none;
            padding: 0;
        }
        .source-url {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 20px 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="source-url">
        <strong>Source:</strong> <a href="https://konvajs.org/docs/select_and_transform/Basic_demo.html" target="_blank">https://konvajs.org/docs/select_and_transform/Basic_demo.html</a>
    </div>
    <article><div class="theme-doc-markdown markdown"><p><code>Transformer</code> is a special kind of <code>Konva.Group</code>. It allows you easily resize and rotate any node or set of nodes.</p>
<p>To enable it you need to:</p>
<ol>
<li>Create new instance with <code>new Konva.Transformer()</code></li>
<li>Add it to layer</li>
<li>attach to node with <code>transformer.nodes([shape]);</code></li>
</ol>
<p><em>Note:</em> Transforming tool is not changing <code>width</code> and <code>height</code> properties of nodes when you resize them. Instead it changes <code>scaleX</code> and <code>scaleY</code> properties.</p>
<p><strong>Instructions: Try to resize and rotate shapes. Click on empty area to remove selection. Use SHIFT or CTRL to add/remove shapes into/from selection. Try to select area on a canvas.</strong></p>
<!-- -->
<div class="tabs-container tabList__CuJ"><ul aria-orientation="horizontal" class="tabs" role="tablist"><li aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active" role="tab" tabindex="0">Vanilla</li><li aria-selected="false" class="tabs__item tabItem_LNqP" role="tab" tabindex="-1">React</li><li aria-selected="false" class="tabs__item tabItem_LNqP" role="tab" tabindex="-1">Vue</li></ul><div class="margin-top--md"><div class="tabItem_Ymn6" role="tabpanel"><div class="light sp-c-fVPbOs sp-c-fVPbOs-gMQIch-variant-light sp-wrapper"><div class="sp-c-ikJbEZ sp-layout"><div class="sp-c-euXojQ sp-editor sp-stack" style="height:400px;flex-grow:50;flex-shrink:50;flex-basis:0;overflow:hidden"><div class="sp-c-dyHYiL sp-tabs" translate="no"><div aria-label="Select active file" class="sp-c-gGbYbQ sp-tabs-scrollable-container" role="tablist"><div aria-controls="/index.html-:Rdma7d6laqh:-tab-panel" aria-selected="false" class="sp-c-hluGOI sp-tab-container" role="tab"><button class="sp-c-bxeRRt sp-c-pacmO sp-tab-button" data-active="false" id="/index.html-:Rdma7d6laqh:-tab" tabindex="-1" title="/index.html" type="button">index.html</button></div><div aria-controls="/index.js-:Rdma7d6laqh:-tab-panel" aria-selected="true" class="sp-c-hluGOI sp-tab-container" role="tab"><button class="sp-c-bxeRRt sp-c-pacmO sp-tab-button" data-active="true" id="/index.js-:Rdma7d6laqh:-tab" tabindex="0" title="/index.js" type="button">index.js</button></div></div></div><div aria-labelledby="/index.js-:Rdma7d6laqh:-tab" class="sp-c-gtcpyq sp-code-editor" id="/index.js-:Rdma7d6laqh:-tab-panel" role="tabpanel"><div aria-autocomplete="list" aria-label="Code Editor for index.js" aria-multiline="true" class="sp-pristine sp-javascript sp-c-jOWzsE sp-c-jkvvao sp-cm" role="textbox" tabindex="0" translate="no"><pre class="sp-c-fWymNx sp-pre-placeholder" style="margin-left:var(--sp-space-5)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-plain">Konva</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">'konva'</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">width</span> = <span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">innerWidth</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">height</span> = <span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">innerHeight</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">stage</span> = <span class="sp-syntax-keyword">new</span> <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Stage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-property">container</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'container'</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">width</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">height</span><span class="sp-syntax-punctuation">,</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">layer</span> = <span class="sp-syntax-keyword">new</span> <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Layer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">add</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">layer</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-comment">// create rectangle</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rect1</span> = <span class="sp-syntax-keyword">new</span> <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Rect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">60</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">60</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">100</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">90</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">fill</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'red'</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">name</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rect'</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">draggable</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">true</span><span class="sp-syntax-punctuation">,</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-plain">layer</span>.<span class="sp-syntax-property">add</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rect2</span> = <span class="sp-syntax-keyword">new</span> <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Rect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">250</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">100</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">150</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">90</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">fill</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'green'</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">name</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rect'</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">draggable</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">true</span><span class="sp-syntax-punctuation">,</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-plain">layer</span>.<span class="sp-syntax-property">add</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-comment">// create transformer</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">tr</span> = <span class="sp-syntax-keyword">new</span> <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Transformer</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-plain">layer</span>.<span class="sp-syntax-property">add</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">tr</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-comment">// add a new feature, lets add ability to draw selection rectangle</span>
<span class="sp-syntax-keyword">let</span> <span class="sp-syntax-plain">selectionRectangle</span> = <span class="sp-syntax-keyword">new</span> <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Rect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-property">fill</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rgba(0,0,255,0.5)'</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">,</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-plain">layer</span>.<span class="sp-syntax-property">add</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">let</span> <span class="sp-syntax-plain">x1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">x2</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y2</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">on</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">'mousedown touchstart'</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-comment">// do nothing if we mousedown on any shape</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span> !== <span class="sp-syntax-plain">stage</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-plain">x1</span> = <span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">y1</span> = <span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">x2</span> = <span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">y2</span> = <span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">setAttrs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">x1</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">y1</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">true</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">on</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">'mousemove touchmove'</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-comment">// do nothing if we didn't start selection</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-plain">x2</span> = <span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">y2</span> = <span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">setAttrs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">x2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">y1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">abs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x2</span> - <span class="sp-syntax-plain">x1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">abs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">y2</span> - <span class="sp-syntax-plain">y1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">on</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">'mouseup touchend'</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-comment">// do nothing if we didn't start selection</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-comment">// update visibility in timeout, so we can check it in click event</span>
  <span class="sp-syntax-definition">setTimeout</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">var</span> <span class="sp-syntax-plain">shapes</span> = <span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">find</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">'.rect'</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">var</span> <span class="sp-syntax-plain">box</span> = <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">getClientRect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">var</span> <span class="sp-syntax-plain">selected</span> = <span class="sp-syntax-plain">shapes</span>.<span class="sp-syntax-property">filter</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">shape</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span>
    <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Util</span>.<span class="sp-syntax-property">haveIntersection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">box</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">shape</span>.<span class="sp-syntax-property">getClientRect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">tr</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selected</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-comment">// clicks should select/deselect shapes</span>
<span class="sp-syntax-plain">stage</span>.<span class="sp-syntax-property">on</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">'click tap'</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-keyword">function</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
<span class="sp-syntax-comment">// if we are selecting with rect, do nothing</span>
<span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> &amp;&amp; <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> &gt; <span class="sp-syntax-static">0</span> &amp;&amp; <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> &gt; <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span>

  <span class="sp-syntax-comment">// if click on empty area - remove all selections</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span> === <span class="sp-syntax-plain">stage</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-plain">tr</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>

  <span class="sp-syntax-comment">// do nothing if clicked NOT on our rectangles</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">hasName</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">'rect'</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>

  <span class="sp-syntax-comment">// do we pressed shift or ctrl?</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">metaPressed</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">shiftKey</span> || <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">ctrlKey</span> || <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">metaKey</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">isSelected</span> = <span class="sp-syntax-plain">tr</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">indexOf</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span><span class="sp-syntax-punctuation">)</span> &gt;= <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">metaPressed</span> &amp;&amp; !<span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// if no key pressed and the node is not selected</span>
    <span class="sp-syntax-comment">// select just one</span>
    <span class="sp-syntax-plain">tr</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">metaPressed</span> &amp;&amp; <span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// if we pressed keys and node was selected</span>
    <span class="sp-syntax-comment">// we need to remove it from selection:</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">nodes</span> = <span class="sp-syntax-plain">tr</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">slice</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span> <span class="sp-syntax-comment">// use slice to have new copy of array</span>
    <span class="sp-syntax-comment">// remove node from array</span>
    <span class="sp-syntax-plain">nodes</span>.<span class="sp-syntax-property">splice</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">nodes</span>.<span class="sp-syntax-property">indexOf</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-plain">tr</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">nodes</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">metaPressed</span> &amp;&amp; !<span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// add the node into selection</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">nodes</span> = <span class="sp-syntax-plain">tr</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">concat</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-plain">tr</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">nodes</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

</pre></div></div></div><div class="sp-c-gvjhpQ sp-c-gvjhpQ-xpXQZ-direction-horizontal sp-resize-handler" data-direction="horizontal" style="left:calc(50% - 5px)"></div><div class="sp-c-euXojQ sp-preview sp-stack" style="flex-grow:50;flex-shrink:50;flex-basis:0;width:50%;gap:0;height:400px"><div class="sp-c-juMdfR sp-preview-container"><iframe class="sp-c-fgviib sp-preview-iframe" title="Sandpack Preview"></iframe><div class="sp-c-kwibBT sp-preview-actions"><a class="sp-icon-standalone sp-c-bxeRRt sp-c-gMfcns sp-c-dEbKhQ sp-button" href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=parcel" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox"><svg fill="none" height="16" stroke="currentColor" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><title>Open on CodeSandbox</title><path d="M6.66665 3.33337H4.33331C3.78103 3.33337 3.33331 3.78109 3.33331 4.33337V11.6667C3.33331 12.219 3.78103 12.6667 4.33331 12.6667H11.6666C12.2189 12.6667 12.6666 12.219 12.6666 11.6667V9.33337" stroke-linecap="round"></path><path d="M10 3.33337H12.5667C12.6219 3.33337 12.6667 3.37815 12.6667 3.43337V6.00004" stroke-linecap="round"></path><path d="M7.33331 8.66668L12.5333 3.46667" stroke-linecap="round"></path></svg><span>Open Sandbox</span></a></div></div></div></div></div></div><div class="tabItem_Ymn6" hidden="" role="tabpanel"><div class="light sp-c-fVPbOs sp-c-fVPbOs-gMQIch-variant-light sp-wrapper"><div class="sp-c-ikJbEZ sp-layout"><div class="sp-c-euXojQ sp-editor sp-stack" style="height:400px;flex-grow:50;flex-shrink:50;flex-basis:0;overflow:hidden"><div aria-labelledby="/App.js-:Rema7d6laqh:-tab" class="sp-c-gtcpyq sp-code-editor" id="/App.js-:Rema7d6laqh:-tab-panel" role="tabpanel"><div aria-autocomplete="list" aria-label="Code Editor for App.js" aria-multiline="true" class="sp-pristine sp-javascript sp-c-jOWzsE sp-c-jkvvao sp-cm" role="textbox" tabindex="0" translate="no"><pre class="sp-c-fWymNx sp-pre-placeholder" style="margin-left:var(--sp-space-5)"><span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">Stage</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">Layer</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">Rect</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">Transformer</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">'react-konva'</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">useState</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useEffect</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">useRef</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">'react'</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">initialRectangles</span> = <span class="sp-syntax-punctuation">[</span>
  <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">60</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">60</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">100</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">90</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">fill</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'red'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rect1'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">name</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rect'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">250</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">100</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">150</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">90</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">fill</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'green'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rect2'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">name</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rect'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span>
<span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-comment">// Helper functions for calculating bounding boxes of rotated rectangles</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">degToRad</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">angle</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">angle</span> / <span class="sp-syntax-static">180</span><span class="sp-syntax-punctuation">)</span> * <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">PI</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">getCorner</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">pivotX</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">pivotY</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">diffX</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">diffY</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">angle</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">distance</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">sqrt</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">diffX</span> * <span class="sp-syntax-plain">diffX</span> + <span class="sp-syntax-plain">diffY</span> * <span class="sp-syntax-plain">diffY</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">angle</span> += <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">atan2</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">diffY</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">diffX</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">x</span> = <span class="sp-syntax-plain">pivotX</span> + <span class="sp-syntax-plain">distance</span> * <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">cos</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">angle</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">y</span> = <span class="sp-syntax-plain">pivotY</span> + <span class="sp-syntax-plain">distance</span> * <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">sin</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">angle</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">y</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">getClientRect</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">element</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">rotation</span> = <span class="sp-syntax-static">0</span> <span class="sp-syntax-punctuation">}</span> = <span class="sp-syntax-plain">element</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rad</span> = <span class="sp-syntax-definition">degToRad</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rotation</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">p1</span> = <span class="sp-syntax-definition">getCorner</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">rad</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">p2</span> = <span class="sp-syntax-definition">getCorner</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">width</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">rad</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">p3</span> = <span class="sp-syntax-definition">getCorner</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">width</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">height</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">rad</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">p4</span> = <span class="sp-syntax-definition">getCorner</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">height</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">rad</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">minX</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">p1</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p2</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p3</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p4</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">minY</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">p1</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p2</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p3</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p4</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">maxX</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">max</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">p1</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p2</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p3</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p4</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">maxY</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">max</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">p1</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p2</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p3</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p4</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">minX</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">minY</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">maxX</span> - <span class="sp-syntax-plain">minX</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">maxY</span> - <span class="sp-syntax-plain">minY</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">App</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">rectangles</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setRectangles</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">initialRectangles</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">selectedIds</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setSelectedIds</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">selectionRectangle</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">setSelectionRectangle</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-definition">useState</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">x2</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y2</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">isSelecting</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">transformerRef</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rectRefs</span> = <span class="sp-syntax-definition">useRef</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">new</span> Map<span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-comment">// Update transformer when selection changes</span>
  <span class="sp-syntax-definition">useEffect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">length</span> &amp;&amp; <span class="sp-syntax-plain">transformerRef</span>.<span class="sp-syntax-property">current</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-comment">// Get the nodes from the refs Map</span>
      <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">nodes</span> = <span class="sp-syntax-plain">selectedIds</span>
        .<span class="sp-syntax-property">map</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">id</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">rectRefs</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">get</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">id</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span>
        .<span class="sp-syntax-property">filter</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">node</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">node</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      
      <span class="sp-syntax-plain">transformerRef</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">nodes</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">transformerRef</span>.<span class="sp-syntax-property">current</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-comment">// Clear selection</span>
      <span class="sp-syntax-plain">transformerRef</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">selectedIds</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-comment">// Click handler for stage</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleStageClick</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// If we are selecting with rect, do nothing</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>

    <span class="sp-syntax-comment">// If click on empty area - remove all selections</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span> === <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">getStage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-definition">setSelectedIds</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>

    <span class="sp-syntax-comment">// Do nothing if clicked NOT on our rectangles</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">hasName</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">'rect'</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>

    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">clickedId</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    
    <span class="sp-syntax-comment">// Do we pressed shift or ctrl?</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">metaPressed</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">shiftKey</span> || <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">ctrlKey</span> || <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">metaKey</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">isSelected</span> = <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">includes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">clickedId</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">metaPressed</span> &amp;&amp; !<span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-comment">// If no key pressed and the node is not selected</span>
      <span class="sp-syntax-comment">// select just one</span>
      <span class="sp-syntax-definition">setSelectedIds</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">clickedId</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">metaPressed</span> &amp;&amp; <span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-comment">// If we pressed keys and node was selected</span>
      <span class="sp-syntax-comment">// we need to remove it from selection</span>
      <span class="sp-syntax-definition">setSelectedIds</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">filter</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">id</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">id</span> !== <span class="sp-syntax-plain">clickedId</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">metaPressed</span> &amp;&amp; !<span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-comment">// Add the node into selection</span>
      <span class="sp-syntax-definition">setSelectedIds</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">selectedIds</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">clickedId</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleMouseDown</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// Do nothing if we mousedown on any shape</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span> !== <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">getStage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
    
    <span class="sp-syntax-comment">// Start selection rectangle</span>
    <span class="sp-syntax-plain">isSelecting</span>.<span class="sp-syntax-property">current</span> = <span class="sp-syntax-static">true</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">pos</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">getStage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-definition">setSelectionRectangle</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">true</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">x2</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">y2</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleMouseMove</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// Do nothing if we didn't start selection</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isSelecting</span>.<span class="sp-syntax-property">current</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
    
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">pos</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">getStage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-definition">setSelectionRectangle</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">selectionRectangle</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">x2</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">y2</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleMouseUp</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// Do nothing if we didn't start selection</span>
    <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isSelecting</span>.<span class="sp-syntax-property">current</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span>
    <span class="sp-syntax-plain">isSelecting</span>.<span class="sp-syntax-property">current</span> = <span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">;</span>
    
    <span class="sp-syntax-comment">// Update visibility in timeout, so we can check it in click event</span>
    <span class="sp-syntax-definition">setTimeout</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-definition">setSelectionRectangle</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
        <span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">selectionRectangle</span><span class="sp-syntax-punctuation">,</span>
        <span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">selBox</span> = <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">abs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x2</span> - <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
      <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">abs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y2</span> - <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">selected</span> = <span class="sp-syntax-plain">rectangles</span>.<span class="sp-syntax-property">filter</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-comment">// Check if rectangle intersects with selection box</span>
      <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Util</span>.<span class="sp-syntax-property">haveIntersection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selBox</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-definition">getClientRect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    
    <span class="sp-syntax-definition">setSelectedIds</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selected</span>.<span class="sp-syntax-property">map</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleDragEnd</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">id</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-definition">setRectangles</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">prevRects</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">newRects</span> = <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">prevRects</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">index</span> = <span class="sp-syntax-plain">newRects</span>.<span class="sp-syntax-property">findIndex</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">r</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">r</span>.<span class="sp-syntax-property">id</span> === <span class="sp-syntax-plain">id</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">index</span> !== -<span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
        <span class="sp-syntax-plain">newRects</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-punctuation">{</span>
          <span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">newRects</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">,</span>
          <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
          <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>
        <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-plain">newRects</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleTransformEnd</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// Find which rectangle(s) were transformed</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">id</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">node</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span><span class="sp-syntax-punctuation">;</span>
    
    <span class="sp-syntax-definition">setRectangles</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">prevRects</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
      <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">newRects</span> = <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">prevRects</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">;</span>
      
      <span class="sp-syntax-comment">// Update each transformed node</span>
      <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">index</span> = <span class="sp-syntax-plain">newRects</span>.<span class="sp-syntax-property">findIndex</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">r</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">r</span>.<span class="sp-syntax-property">id</span> === <span class="sp-syntax-plain">id</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
      
      <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">index</span> !== -<span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
        <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">scaleX</span> = <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">scaleX</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
        <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">scaleY</span> = <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">scaleY</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
        
        <span class="sp-syntax-comment">// Reset scale</span>
        <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">scaleX</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
        <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">scaleY</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
        
        <span class="sp-syntax-comment">// Update the state with new values</span>
        <span class="sp-syntax-plain">newRects</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-punctuation">{</span>
          <span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">newRects</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">,</span>
          <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
          <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
          <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">max</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">5</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> * <span class="sp-syntax-plain">scaleX</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
          <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">max</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> * <span class="sp-syntax-plain">scaleY</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
          <span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
        <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
      <span class="sp-syntax-punctuation">}</span>
      
      <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-plain">newRects</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">(</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">Stage</span>
      <span class="sp-syntax-property">width</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">innerWidth</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-property">height</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">innerHeight</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-property">onMouseDown</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">handleMouseDown</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-property">onMousemove</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">handleMouseMove</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-property">onMouseup</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">handleMouseUp</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-property">onClick</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">handleStageClick</span><span class="sp-syntax-punctuation">}</span>
    <span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">Layer</span><span class="sp-syntax-punctuation">&gt;</span>
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-comment">/* Render rectangles directly */</span>}
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rectangles</span>.<span class="sp-syntax-property">map</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">(</span>
          <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">Rect</span>
            <span class="sp-syntax-property">key</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">id</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">x</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">y</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">width</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">height</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">fill</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">fill</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">name</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">name</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">rotation</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">draggable</span>
            <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">node</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
              <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">node</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
                <span class="sp-syntax-plain">rectRefs</span>.<span class="sp-syntax-property">current</span>.<span class="sp-syntax-property">set</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">node</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
              <span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">onDragEnd</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">handleDragEnd</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">onTransformEnd</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">handleTransformEnd</span><span class="sp-syntax-punctuation">}</span>
          <span class="sp-syntax-punctuation">/&gt;</span>
        <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span>
        
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-comment">/* Single transformer for all selected shapes */</span>}
        <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">Transformer</span>
          <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">transformerRef</span><span class="sp-syntax-punctuation">}</span>
          <span class="sp-syntax-property">boundBoxFunc</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">oldBox</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">newBox</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
            <span class="sp-syntax-comment">// Limit resize</span>
            <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">newBox</span>.<span class="sp-syntax-property">width</span> &lt; <span class="sp-syntax-static">5</span> || <span class="sp-syntax-plain">newBox</span>.<span class="sp-syntax-property">height</span> &lt; <span class="sp-syntax-static">5</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
              <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-plain">oldBox</span><span class="sp-syntax-punctuation">;</span>
            <span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-plain">newBox</span><span class="sp-syntax-punctuation">;</span>
          <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">}</span>
          
        <span class="sp-syntax-punctuation">/&gt;</span>
        
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-comment">/* Selection rectangle */</span>}
        <span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span> &amp;&amp; <span class="sp-syntax-punctuation">(</span>
          <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">Rect</span>
            <span class="sp-syntax-property">x</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">y</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">width</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">abs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x2</span> - <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">height</span>=<span class="sp-syntax-punctuation">{</span><span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">abs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y2</span> - <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span>
            <span class="sp-syntax-property">fill</span>=<span class="sp-syntax-string">"rgba(0,0,255,0.5)"</span>
          <span class="sp-syntax-punctuation">/&gt;</span>
        <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">}</span>
      <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-definition">Layer</span><span class="sp-syntax-punctuation">&gt;</span>
    <span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-definition">Stage</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">export</span> <span class="sp-syntax-keyword">default</span> <span class="sp-syntax-plain">App</span><span class="sp-syntax-punctuation">;</span>

</pre></div></div></div><div class="sp-c-gvjhpQ sp-c-gvjhpQ-xpXQZ-direction-horizontal sp-resize-handler" data-direction="horizontal" style="left:calc(50% - 5px)"></div><div class="sp-c-euXojQ sp-preview sp-stack" style="flex-grow:50;flex-shrink:50;flex-basis:0;width:50%;gap:0;height:400px"><div class="sp-c-juMdfR sp-preview-container"><iframe class="sp-c-fgviib sp-preview-iframe" title="Sandpack Preview"></iframe><div class="sp-c-kwibBT sp-preview-actions"><a class="sp-icon-standalone sp-c-bxeRRt sp-c-gMfcns sp-c-dEbKhQ sp-button" href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=create-react-app" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox"><svg fill="none" height="16" stroke="currentColor" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><title>Open on CodeSandbox</title><path d="M6.66665 3.33337H4.33331C3.78103 3.33337 3.33331 3.78109 3.33331 4.33337V11.6667C3.33331 12.219 3.78103 12.6667 4.33331 12.6667H11.6666C12.2189 12.6667 12.6666 12.219 12.6666 11.6667V9.33337" stroke-linecap="round"></path><path d="M10 3.33337H12.5667C12.6219 3.33337 12.6667 3.37815 12.6667 3.43337V6.00004" stroke-linecap="round"></path><path d="M7.33331 8.66668L12.5333 3.46667" stroke-linecap="round"></path></svg><span>Open Sandbox</span></a></div></div></div></div></div></div><div class="tabItem_Ymn6" hidden="" role="tabpanel"><div class="light sp-c-fVPbOs sp-c-fVPbOs-gMQIch-variant-light sp-wrapper"><div class="sp-c-ikJbEZ sp-layout"><div class="sp-c-euXojQ sp-editor sp-stack" style="height:400px;flex-grow:50;flex-shrink:50;flex-basis:0;overflow:hidden"><div class="sp-c-dyHYiL sp-tabs" translate="no"><div aria-label="Select active file" class="sp-c-gGbYbQ sp-tabs-scrollable-container" role="tablist"><div aria-controls="/src/App.vue-:Rfma7d6laqh:-tab-panel" aria-selected="true" class="sp-c-hluGOI sp-tab-container" role="tab"><button class="sp-c-bxeRRt sp-c-pacmO sp-tab-button" data-active="true" id="/src/App.vue-:Rfma7d6laqh:-tab" tabindex="0" title="/src/App.vue" type="button">App.vue</button></div><div aria-controls="/src/main.js-:Rfma7d6laqh:-tab-panel" aria-selected="false" class="sp-c-hluGOI sp-tab-container" role="tab"><button class="sp-c-bxeRRt sp-c-pacmO sp-tab-button" data-active="false" id="/src/main.js-:Rfma7d6laqh:-tab" tabindex="-1" title="/src/main.js" type="button">main.js</button></div></div></div><div aria-labelledby="/src/App.vue-:Rfma7d6laqh:-tab" class="sp-c-gtcpyq sp-code-editor" id="/src/App.vue-:Rfma7d6laqh:-tab-panel" role="tabpanel"><div aria-autocomplete="list" aria-label="Code Editor for App.vue" aria-multiline="true" class="sp-pristine sp-html sp-c-jOWzsE sp-c-jkvvao sp-cm" role="textbox" tabindex="0" translate="no"><pre class="sp-c-fWymNx sp-pre-placeholder" style="margin-left:var(--sp-space-5)"><span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">template</span><span class="sp-syntax-punctuation">&gt;</span>
  <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">v-stage</span>
    <span class="sp-syntax-property">:config</span>=<span class="sp-syntax-string">"stageSize"</span>
    <span class="sp-syntax-property">@mousedown</span>=<span class="sp-syntax-string">"handleMouseDown"</span>
    <span class="sp-syntax-property">@mousemove</span>=<span class="sp-syntax-string">"handleMouseMove"</span>
    <span class="sp-syntax-property">@mouseup</span>=<span class="sp-syntax-string">"handleMouseUp"</span>
    <span class="sp-syntax-property">@click</span>=<span class="sp-syntax-string">"handleStageClick"</span>
    <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-string">"stageRef"</span>
  <span class="sp-syntax-punctuation">&gt;</span>
    <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">v-layer</span> <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-string">"layerRef"</span><span class="sp-syntax-punctuation">&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">v-rect</span>
        <span class="sp-syntax-property">v-for</span>=<span class="sp-syntax-string">"(rect, i) in rectangles"</span>
        <span class="sp-syntax-property">:key</span>=<span class="sp-syntax-string">"i"</span>
        <span class="sp-syntax-property">:config</span>=<span class="sp-syntax-string">"{
          ...rect,
          name: 'rect', // Important to match vanilla version's logic
          draggable: true
        }"</span>
        <span class="sp-syntax-property">@dragend</span>=<span class="sp-syntax-string">"(e) =&gt; handleDragEnd(e, i)"</span>
        <span class="sp-syntax-property">@transformend</span>=<span class="sp-syntax-string">"(e) =&gt; handleTransformEnd(e, i)"</span>
        <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-string">"rectRefs"</span>
      <span class="sp-syntax-punctuation">/&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">v-transformer</span>
        <span class="sp-syntax-property">ref</span>=<span class="sp-syntax-string">"transformerRef"</span>
        <span class="sp-syntax-property">:config</span>=<span class="sp-syntax-string">"{
          boundBoxFunc: (oldBox, newBox) =&gt; {
            // limit resize
            if (newBox.width &lt; 5 || newBox.height &lt; 5) {
              return oldBox;
            }
            return newBox;
          },
        }"</span>
      <span class="sp-syntax-punctuation">/&gt;</span>
      <span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">v-rect</span>
        <span class="sp-syntax-property">v-if</span>=<span class="sp-syntax-string">"selectionRectangle.visible"</span>
        <span class="sp-syntax-property">:config</span>=<span class="sp-syntax-string">"{
          x: Math.min(selectionRectangle.x1, selectionRectangle.x2),
          y: Math.min(selectionRectangle.y1, selectionRectangle.y2),
          width: Math.abs(selectionRectangle.x2 - selectionRectangle.x1),
          height: Math.abs(selectionRectangle.y2 - selectionRectangle.y1),
          fill: 'rgba(0,0,255,0.5)'
        }"</span>
      <span class="sp-syntax-punctuation">/&gt;</span>
    &lt;/v-layer&gt;
  &lt;/v-stage&gt;
&lt;/template&gt;

<span class="sp-syntax-punctuation">&lt;</span><span class="sp-syntax-definition">script</span> <span class="sp-syntax-property">setup</span><span class="sp-syntax-punctuation">&gt;</span>
<span class="sp-syntax-keyword">import</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-plain">ref</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">watch</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">reactive</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">onMounted</span> <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">from</span> <span class="sp-syntax-string">'vue'</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">stageSize</span> = <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">innerWidth</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">window</span>.<span class="sp-syntax-property">innerHeight</span><span class="sp-syntax-punctuation">,</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rectangles</span> = <span class="sp-syntax-definition">ref</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span>
  <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">60</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">60</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">100</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">90</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">fill</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'red'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rect1'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">250</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">100</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">150</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">90</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">fill</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'green'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-string">'rect2'</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">,</span>
<span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">selectedIds</span> = <span class="sp-syntax-definition">ref</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rectRefs</span> = <span class="sp-syntax-definition">ref</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">transformerRef</span> = <span class="sp-syntax-definition">ref</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">stageRef</span> = <span class="sp-syntax-definition">ref</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">layerRef</span> = <span class="sp-syntax-definition">ref</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-keyword">null</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">isSelecting</span> = <span class="sp-syntax-definition">ref</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">selectionRectangle</span> = <span class="sp-syntax-definition">reactive</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">x2</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-property">y2</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-static">0</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-comment">// Helper functions for calculating bounding boxes of rotated rectangles</span>
<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">degToRad</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">angle</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">angle</span> / <span class="sp-syntax-static">180</span><span class="sp-syntax-punctuation">)</span> * <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">PI</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">getCorner</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">pivotX</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">pivotY</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">diffX</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">diffY</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">angle</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">distance</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">sqrt</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">diffX</span> * <span class="sp-syntax-plain">diffX</span> + <span class="sp-syntax-plain">diffY</span> * <span class="sp-syntax-plain">diffY</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">angle</span> += <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">atan2</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">diffY</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">diffX</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">x</span> = <span class="sp-syntax-plain">pivotX</span> + <span class="sp-syntax-plain">distance</span> * <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">cos</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">angle</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">y</span> = <span class="sp-syntax-plain">pivotY</span> + <span class="sp-syntax-plain">distance</span> * <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">sin</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">angle</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">y</span> <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">getClientRect</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">element</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-punctuation">{</span> <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-property">rotation</span> = <span class="sp-syntax-static">0</span> <span class="sp-syntax-punctuation">}</span> = <span class="sp-syntax-plain">element</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rad</span> = <span class="sp-syntax-definition">degToRad</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rotation</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">p1</span> = <span class="sp-syntax-definition">getCorner</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">rad</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">p2</span> = <span class="sp-syntax-definition">getCorner</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">width</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">rad</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">p3</span> = <span class="sp-syntax-definition">getCorner</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">width</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">height</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">rad</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">p4</span> = <span class="sp-syntax-definition">getCorner</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-static">0</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">height</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">rad</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">minX</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">p1</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p2</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p3</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p4</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">minY</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">p1</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p2</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p3</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p4</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">maxX</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">max</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">p1</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p2</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p3</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p4</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">maxY</span> = <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">max</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">p1</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p2</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p3</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">p4</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">minX</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">minY</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">maxX</span> - <span class="sp-syntax-plain">minX</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">maxY</span> - <span class="sp-syntax-plain">minY</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-comment">// Update transformer nodes when selection changes</span>
<span class="sp-syntax-definition">watch</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectedIds</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">transformerRef</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">nodes</span> = <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span>.<span class="sp-syntax-property">map</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">id</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-plain">rectRefs</span>.<span class="sp-syntax-property">value</span>.<span class="sp-syntax-property">find</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">ref</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">ref</span>.<span class="sp-syntax-property">getNode</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">attrs</span>.<span class="sp-syntax-property">id</span> === <span class="sp-syntax-plain">id</span><span class="sp-syntax-punctuation">)</span>?.<span class="sp-syntax-property">getNode</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">filter</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">Boolean</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-plain">transformerRef</span>.<span class="sp-syntax-property">value</span>.<span class="sp-syntax-property">getNode</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">nodes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">nodes</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleStageClick</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-comment">// if we are selecting with rect, do nothing</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>

  <span class="sp-syntax-comment">// if click on empty area - remove all selections</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span> === <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">getStage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">;</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>

  <span class="sp-syntax-comment">// do nothing if clicked NOT on our rectangles</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">hasName</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-string">'rect'</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
  
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">clickedId</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">attrs</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-comment">// do we pressed shift or ctrl?</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">metaPressed</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">shiftKey</span> || <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">ctrlKey</span> || <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">evt</span>.<span class="sp-syntax-property">metaKey</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">isSelected</span> = <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span>.<span class="sp-syntax-property">includes</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">clickedId</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">metaPressed</span> &amp;&amp; !<span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// if no key pressed and the node is not selected</span>
    <span class="sp-syntax-comment">// select just one</span>
    <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">clickedId</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">metaPressed</span> &amp;&amp; <span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// if we pressed keys and node was selected</span>
    <span class="sp-syntax-comment">// we need to remove it from selection:</span>
    <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span>.<span class="sp-syntax-property">filter</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">id</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">id</span> !== <span class="sp-syntax-plain">clickedId</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span> <span class="sp-syntax-keyword">else</span> <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">metaPressed</span> &amp;&amp; !<span class="sp-syntax-plain">isSelected</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// add the node into selection</span>
    <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">clickedId</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleMouseDown</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-comment">// do nothing if we mousedown on any shape</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span> !== <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">getStage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
  
  <span class="sp-syntax-comment">// start selection rectangle</span>
  <span class="sp-syntax-plain">isSelecting</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-static">true</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">pos</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">getStage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span> = <span class="sp-syntax-static">true</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x1</span> = <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y1</span> = <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x2</span> = <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y2</span> = <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleMouseMove</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-comment">// do nothing if we didn't start selection</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isSelecting</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
  
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">pos</span> = <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">getStage</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span>.<span class="sp-syntax-property">getPointerPosition</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x2</span> = <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y2</span> = <span class="sp-syntax-plain">pos</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleMouseUp</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-comment">// do nothing if we didn't start selection</span>
  <span class="sp-syntax-keyword">if</span> <span class="sp-syntax-punctuation">(</span>!<span class="sp-syntax-plain">isSelecting</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-keyword">return</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span>
  
  <span class="sp-syntax-plain">isSelecting</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-comment">// update visibility in timeout, so we can check it in click event</span>
  <span class="sp-syntax-definition">setTimeout</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">visible</span> = <span class="sp-syntax-static">false</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">selBox</span> = <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">min</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y2</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">abs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x2</span> - <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">x1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">abs</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y2</span> - <span class="sp-syntax-plain">selectionRectangle</span>.<span class="sp-syntax-property">y1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">selected</span> = <span class="sp-syntax-plain">rectangles</span>.<span class="sp-syntax-property">value</span>.<span class="sp-syntax-property">filter</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-comment">// Check if rectangle intersects with selection box</span>
    <span class="sp-syntax-keyword">return</span> <span class="sp-syntax-plain">Konva</span>.<span class="sp-syntax-property">Util</span>.<span class="sp-syntax-property">haveIntersection</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">selBox</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-definition">getClientRect</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-plain">selectedIds</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-plain">selected</span>.<span class="sp-syntax-property">map</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">rect</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-plain">rect</span>.<span class="sp-syntax-property">id</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleDragEnd</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rects</span> = <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">rectangles</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">rects</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">rects</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">e</span>.<span class="sp-syntax-property">target</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">rectangles</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-plain">rects</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>

<span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">handleTransformEnd</span> = <span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">e</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">)</span> <span class="sp-syntax-punctuation">=&gt;</span> <span class="sp-syntax-punctuation">{</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">node</span> = <span class="sp-syntax-plain">rectRefs</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span>.<span class="sp-syntax-property">getNode</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">scaleX</span> = <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">scaleX</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">scaleY</span> = <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">scaleY</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>

  <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">scaleX</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">scaleY</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">1</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">;</span>
  
  <span class="sp-syntax-keyword">const</span> <span class="sp-syntax-plain">rects</span> = <span class="sp-syntax-punctuation">[</span><span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">rectangles</span>.<span class="sp-syntax-property">value</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">rects</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span> = <span class="sp-syntax-punctuation">{</span>
    <span class="sp-syntax-punctuation">...</span><span class="sp-syntax-plain">rects</span><span class="sp-syntax-punctuation">[</span><span class="sp-syntax-plain">index</span><span class="sp-syntax-punctuation">]</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">x</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">y</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">max</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-static">5</span><span class="sp-syntax-punctuation">,</span> <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">width</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> * <span class="sp-syntax-plain">scaleX</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">Math</span>.<span class="sp-syntax-property">max</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">height</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span> * <span class="sp-syntax-plain">scaleY</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
    <span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">:</span> <span class="sp-syntax-plain">node</span>.<span class="sp-syntax-property">rotation</span><span class="sp-syntax-punctuation">(</span><span class="sp-syntax-punctuation">)</span><span class="sp-syntax-punctuation">,</span>
  <span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
  <span class="sp-syntax-plain">rectangles</span>.<span class="sp-syntax-property">value</span> = <span class="sp-syntax-plain">rects</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">}</span><span class="sp-syntax-punctuation">;</span>
<span class="sp-syntax-punctuation">&lt;/</span><span class="sp-syntax-definition">script</span><span class="sp-syntax-punctuation">&gt;</span>

</pre></div></div></div><div class="sp-c-gvjhpQ sp-c-gvjhpQ-xpXQZ-direction-horizontal sp-resize-handler" data-direction="horizontal" style="left:calc(50% - 5px)"></div><div class="sp-c-euXojQ sp-preview sp-stack" style="flex-grow:50;flex-shrink:50;flex-basis:0;width:50%;gap:0;height:400px"><div class="sp-c-juMdfR sp-preview-container"><iframe class="sp-c-fgviib sp-preview-iframe" title="Sandpack Preview"></iframe><div class="sp-c-kwibBT sp-preview-actions"><a class="sp-icon-standalone sp-c-bxeRRt sp-c-gMfcns sp-c-dEbKhQ sp-button" href="https://codesandbox.io/api/v1/sandboxes/define?undefined&amp;environment=vue-cli" rel="noreferrer noopener" target="_blank" title="Open in CodeSandbox"><svg fill="none" height="16" stroke="currentColor" viewbox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><title>Open on CodeSandbox</title><path d="M6.66665 3.33337H4.33331C3.78103 3.33337 3.33331 3.78109 3.33331 4.33337V11.6667C3.33331 12.219 3.78103 12.6667 4.33331 12.6667H11.6666C12.2189 12.6667 12.6666 12.219 12.6666 11.6667V9.33337" stroke-linecap="round"></path><path d="M10 3.33337H12.5667C12.6219 3.33337 12.6667 3.37815 12.6667 3.43337V6.00004" stroke-linecap="round"></path><path d="M7.33331 8.66668L12.5333 3.46667" stroke-linecap="round"></path></svg><span>Open Sandbox</span></a></div></div></div></div></div></div></div></div>
<pre class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa" tabindex="0"><code class="codeBlockLines_e6Vv"></code></pre></div></article>
</body>
</html>